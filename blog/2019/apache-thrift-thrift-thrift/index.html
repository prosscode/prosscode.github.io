<!DOCTYPE HTML><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="chrome=1"><title>Apache-Thrift-Thrift-Thrift | 博客</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="author" content="pross"><meta name="description" content="接着上篇文章说。
我们知道了Apache Thrift主要用于各个服务之间的RPC通信，并且支持跨语言；包括C++，Java，Python，PHP，Ruby，Go，Node.js等等，还有一些都没听说过的语言；而且从上篇文章的RPC例子中可以发现，Thrift是一个典型的CS（客户端/服务端）架构；加上跨语言的特性，我们可以推断一下：客户端和服务端是可以使用不同的语言开发的。
如果CS端可以使用不"><meta name="description" content="接着上篇文章说。 我们知道了Apache Thrift主要用于各个服务之间的RPC通信，并且支持跨语言；包括C++，Java，Python，PHP，Ruby，Go，Node.js等等，还有一些都没听说过的语言；而且从上篇文章的RPC例子中可以发现，Thrift是一个典型的CS（客户端&#x2F;服务端）架构；加上跨语言的特性，我们可以推断一下：客户端和服务端是可以使用不同的语言开发的。 如果CS端可以使用不"><meta property="og:type" content="article"><meta property="og:title" content="Apache-Thrift-Thrift-Thrift"><meta property="og:url" content="https://pross.space/blog/2019/apache-thrift-thrift-thrift/index.html"><meta property="og:site_name" content="博客"><meta property="og:description" content="接着上篇文章说。 我们知道了Apache Thrift主要用于各个服务之间的RPC通信，并且支持跨语言；包括C++，Java，Python，PHP，Ruby，Go，Node.js等等，还有一些都没听说过的语言；而且从上篇文章的RPC例子中可以发现，Thrift是一个典型的CS（客户端&#x2F;服务端）架构；加上跨语言的特性，我们可以推断一下：客户端和服务端是可以使用不同的语言开发的。 如果CS端可以使用不"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://pross.space/blog/2019/apache-thrift-thrift-thrift/dir.png"><meta property="og:image" content="https://pross.space/blog/2019/apache-thrift-thrift-thrift/thrift.png"><meta property="article:published_time" content="2019-09-09T15:10:18.000Z"><meta property="article:modified_time" content="2021-12-05T02:46:22.837Z"><meta property="article:author" content="pross"><meta property="article:tag" content="技术"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://pross.space/blog/2019/apache-thrift-thrift-thrift/dir.png"><link rel="alternate" href="/atom.xml" title="博客" type="application/atom+xml"><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="stylesheet" href="/css/style.css"><!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--><script>let HEXO_MMEDIA_DATA={js:[],css:[],aplayerData:[],metingData:[],artPlayerData:[],dplayerData:[]}</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="wrapper"><header id="header"><div class="title"><h1><a href="/">博客</a></h1><p><a href="/"></a></p></div><nav class="nav"><ul><li><a href="/">Home</a></li><li><a href="/archives">Archives</a></li><li><a href="/about">About</a></li><li><a href="/daysmatter">Daysmatter</a></li><li><a href="/atom.xml">RSS</a></li></ul><div class="clearfix"></div></nav><div class="clearfix"></div></header><div class="content"><article class="post"><header><div class="icon"></div><a href="/blog/2019/apache-thrift-thrift-thrift/"><time datetime="2019-09-09T15:10:18.000Z">2019-09-09</time></a><h1 class="title">Apache-Thrift-Thrift-Thrift</h1></header><div class="entry"><p>接着上篇文章说。</p><p>我们知道了Apache Thrift主要用于各个服务之间的RPC通信，并且支持跨语言；包括C++，Java，Python，PHP，Ruby，Go，Node.js等等，还有一些都没听说过的语言；而且从上篇文章的RPC例子中可以发现，Thrift是一个典型的CS（客户端/服务端）架构；加上跨语言的特性，我们可以推断一下：客户端和服务端是可以使用不同的语言开发的。</p><p>如果CS端可以使用不同的语言来开发，那么一定是有一种中间语言来关联客户端和服务端（相同语言也需要关联客户端和服务端）。其实这个答案都知道，那就是接口定义语言：IDL（Interface Description Language）；下面我们从IDL进行开场表演，进行一次Thrift RPC的完整演出。</p><span id="more"></span><h3 id="接口描述语言IDL"><a href="#接口描述语言IDL" class="headerlink" title="接口描述语言IDL"></a>接口描述语言IDL</h3><p>依旧照例，搬来wiki的解释：</p><blockquote><p>接口描述语言（Interface Description Language，缩写IDL），是用来描述软件组件界面的一种计算机语言。IDL通过一种中立的方式来描述接口，使得在不同平台上运行的对象和用不同语言编写的程序可以相互通信交流；比如，一个组件用C++写成，另一个组件用Java写成。</p><p>IDL通常用于远程调用软件。在这种情况下，一般是由远程客户终端调用不同操作系统上的对象组件，并且这些对象组件可能是由不同计算机语言编写的。IDL建立起了两个不同操作系统间通信的桥梁。</p></blockquote><p>关于IDL数据类型和语法介绍，这里简单列举：</p><p><strong>基本类型</strong></p><ul><li>byte：8位有符号整数（byte）</li><li>i16：16位有符号整数（short）</li><li>i32：32位有符号整数（int）</li><li>i64：64位有符号整数（long）</li><li>double：64位浮点数（double）</li><li>string：字符串（string）</li><li>bool：布尔变量（boolean）</li></ul><blockquote><p>Thrift不支持无符号整数，因为不是所有的语言都支持无符号整数。</p></blockquote><p><strong>容器类型</strong></p><ul><li>list<t>：有序列表，元素可以重复</t></li><li>set<t>：无序集合，元素不可重复</t></li><li>map&lt;k,v&gt;：字典结构，键值对</li></ul><p><strong>结构体</strong></p><p>类似C语言的结构体。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// required和optional，必选和可选</span></span><br><span class="line">struct Example &#123;</span><br><span class="line">   <span class="number">1</span>: required string name;      </span><br><span class="line">   <span class="number">3</span>: optional i32 age;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>枚举类型</strong></p><p>可以像C/C++一样定义枚举类型。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">EnumType</span> </span>&#123;</span><br><span class="line">    NUMBER = <span class="number">2</span></span><br><span class="line">&#125;        </span><br><span class="line"></span><br><span class="line">struct exampleStruct &#123;</span><br><span class="line">    required i32 id;</span><br><span class="line">    required string userName;</span><br><span class="line">    optional EnumType enumType = EnumType.NUMBER;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>异常</strong></p><p>可以自定义异常，所定义的异常会继承对应语言的异常类，比如Java，就会继承<code>java.lang.Exception</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">exception RequestException &#123;</span><br><span class="line">   <span class="number">1</span>: required i32 code;</span><br><span class="line">   <span class="number">2</span>: optional string reason;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>服务</strong></p><p>相当于Java中创建接口（Interface）一样，创建的service经过Thrift代码生成客户端和服务端的框架。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">service exampleService&#123;</span><br><span class="line">    <span class="function">string <span class="title">hello</span><span class="params">(<span class="number">1</span>:string username)</span></span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>命名空间</strong></p><p>关键字<code>namespace</code>，相当于Java中的package，必须需要。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 代码路径：service.study.thrift</span></span><br><span class="line">namespace java service.study.thrift</span><br></pre></td></tr></table></figure><p><strong>常量</strong></p><p>定义常量，复杂的类型和结构体可以使用JSON来表示。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> i32 INT_CONST = <span class="number">20</span>;</span><br><span class="line"><span class="keyword">const</span> map&lt;i32,string&gt; MAP_CONST = &#123;<span class="number">1</span>:<span class="string">&quot;hello&quot;</span>,<span class="number">2</span>:<span class="string">&quot;world&quot;</span>&#125;;</span><br></pre></td></tr></table></figure><p><strong>注释</strong></p><p>支持<code>#</code>和<code>//</code>单行注释，和<code>/***/</code>多行注释。</p><p>我们用以上的的数据类型和语法规则，自定义生成一个Thrift文件，取名叫<code>hello.thrift</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">namespace java org.pross.thrift</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">RequestType</span> </span>&#123;</span><br><span class="line">   SAY_HELLO,   <span class="comment">//问好</span></span><br><span class="line">   QUERY_TIME,  <span class="comment">//询问时间</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct Request &#123;</span><br><span class="line">   <span class="number">1</span>: required RequestType type;  <span class="comment">// 请求的类型，必选</span></span><br><span class="line">   <span class="number">2</span>: required string name;       <span class="comment">// 发起请求的人的名字，必选</span></span><br><span class="line">   <span class="number">3</span>: optional i32 age;           <span class="comment">// 发起请求的人的年龄，可选</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 异常</span></span><br><span class="line">exception RequestException &#123;</span><br><span class="line">   <span class="number">1</span>: required i32 code;</span><br><span class="line">   <span class="number">2</span>: optional string reason;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 服务名，接口：addition()和sayHello()，将会使用到</span></span><br><span class="line">service HelloMethod&#123;</span><br><span class="line">    <span class="function">i32 <span class="title">division</span><span class="params">(<span class="number">1</span>:i32 param1,<span class="number">2</span>:i32 param2)</span> <span class="title">throws</span> <span class="params">(<span class="number">1</span>:RequestException re)</span> <span class="comment">//可能抛出异常</span></span></span><br><span class="line"><span class="function">    string <span class="title">sayHello</span><span class="params">(<span class="number">1</span>:string username)</span></span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure><p>安装好thrift，在终端运行：<code>thrift --gen java hello.thrift</code>，则在当前目录下会生成一个<code>gen-java</code>目录，在该目录下会按照<code>namespace</code>定义路径名，生成文件夹；最终我们可以看到生成了4个Java类：<code>HelloMethod</code>，<code>Ruquest</code>，<code>RequestException</code>和<code>RequestType</code>。<code>hello.thrift</code>文件中定义的enum，struct，exception，service都相应地生成了一个Java类，这就是能支持Java语言通信的基本框架代码。</p><blockquote><p><code>thrift --gen java hello.thrift</code>，指定Java语言生成框架代码。</p><p>如果客户端和服务端使用不同的语言来编写，只需要对选择不同语言的生成框架代码即可。</p></blockquote><p>我们再来看看生成的<code>HelloMethod</code>类的具体结构，简单介绍一下：</p><p><img src="./dir.png"></p><p>对于开发人员而言，需要关注几个核心内部接口/方法：</p><ul><li><p>Iface：服务端通过实现<code>HelloMethod.Iface</code>接口，向客户端提供同步调用业务逻辑的接口。</p></li><li><p>AsyncIface：服务端通过实现<code>HelloMethod.Iface</code>接口，向客户端提供异步调用，异步调用接口多了一个回调参数<code>AsyncMethodCallback&lt;String&gt;</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 同步调用接口  </span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Iface</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">division</span><span class="params">(<span class="keyword">int</span> param1, <span class="keyword">int</span> param2)</span> <span class="keyword">throws</span> RequestException, org.apache.thrift.TException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(String username)</span> <span class="keyword">throws</span> org.apache.thrift.TException</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//异步调用接口</span></span><br><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AsyncIface</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">division</span><span class="params">(<span class="keyword">int</span> param1, <span class="keyword">int</span> param2, org.apache.thrift.async.AsyncMethodCallback&lt;Integer&gt; resultHandler)</span> <span class="keyword">throws</span> org.apache.thrift.TException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">(String username, org.apache.thrift.async.AsyncMethodCallback&lt;String&gt; resultHandler)</span> <span class="keyword">throws</span> org.apache.thrift.TException</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li><li><p>Client/AsyncClient：客户端实例化<code>HelloMethod.Client</code>对象，以同步/异步的方式访问服务端提供的服务方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 提供工厂方法创建client对象</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Factory</span> <span class="keyword">implements</span> <span class="title">org</span>.<span class="title">apache</span>.<span class="title">thrift</span>.<span class="title">TServiceClientFactory</span>&lt;<span class="title">Client</span>&gt; </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Factory</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Client <span class="title">getClient</span><span class="params">(org.apache.thrift.protocol.TProtocol prot)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">new</span> Client(prot);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Client <span class="title">getClient</span><span class="params">(org.apache.thrift.protocol.TProtocol iprot, org.apache.thrift.protocol.TProtocol oprot)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">new</span> Client(iprot, oprot);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 接口方法的客户端代理</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">division</span><span class="params">(<span class="keyword">int</span> param1, <span class="keyword">int</span> param2)</span> <span class="keyword">throws</span> RequestException, org.apache.thrift.TException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">      <span class="comment">// 发送方法调用请求</span></span><br><span class="line">      send_division(param1, param2);</span><br><span class="line">      <span class="comment">// 接收返回值</span></span><br><span class="line">      <span class="keyword">return</span> recv_division();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send_division</span><span class="params">(<span class="keyword">int</span> param1, <span class="keyword">int</span> param2)</span> <span class="keyword">throws</span> org.apache.thrift.TException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">      <span class="comment">// 创建方法参数对象，封装方法参数</span></span><br><span class="line">      division_args args = <span class="keyword">new</span> division_args();</span><br><span class="line">      args.setParam1(param1);</span><br><span class="line">      args.setParam2(param2);</span><br><span class="line">      <span class="comment">// 调用父类方法发送消息</span></span><br><span class="line">      sendBase(<span class="string">&quot;division&quot;</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">...</span><br><span class="line">  	<span class="comment">// org.apache.thrift.TServiceClient.sendBase</span></span><br><span class="line">      <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendBase</span><span class="params">(String methodName, TBase&lt;?, ?&gt; args, <span class="keyword">byte</span> type)</span> <span class="keyword">throws</span> TException </span>&#123;</span><br><span class="line">  		<span class="comment">// 发送消息头（TProtocol）</span></span><br><span class="line">        <span class="keyword">this</span>.oprot_.writeMessageBegin(<span class="keyword">new</span> TMessage(methodName, type, ++<span class="keyword">this</span>.seqid_));</span><br><span class="line">  		<span class="comment">// 发送消息体，由方法参数对象自己处理编码， write(TProtocol)</span></span><br><span class="line">        args.write(<span class="keyword">this</span>.oprot_);</span><br><span class="line">        <span class="keyword">this</span>.oprot_.writeMessageEnd();</span><br><span class="line">        <span class="keyword">this</span>.oprot_.getTransport().flush();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li><li><p>Processor：用来支持方法调用，每个服务实现类需要使用Processor来注册，这样服务器调用接口实现时能定位到具体的实现类。</p></li><li><p>方法参数的封装类：以方法名_args命名</p></li><li><p>方法返回值的封装类：以方法名_result命名</p></li></ul><p>以上就是通过IDL语法规则，生成的中间语言，用于客户端和服务端之间的通信交流。</p><h3 id="Thrift协议栈整体的架构"><a href="#Thrift协议栈整体的架构" class="headerlink" title="Thrift协议栈整体的架构"></a>Thrift协议栈整体的架构</h3><p>OK，我们已经搭建好了<code>Client</code>和<code>Server</code>端相互交流的桥梁了。接下来看看Thrift，了解下整体架构，在编写代码实现逻辑交互时，才能知其所以然。架构如下图：</p><p><img src="./thrift.png" alt="thrift架构"></p><p>在Client和Server的最顶层都是用户自定义的处理逻辑。</p><p>Processor（TProcessor的子类）是服务器端从Thrift框架转入用户逻辑的关键流程，负责对Client的请求做出响应，包括RPC请求转发、调用参数解析、用户逻辑调用，返回值写回等；也对TServer中请求的InputProtocol和OutputTProtocol进行操作，从InputProtocol中读出Client的请求数据，向OutputProtcol中写入用户逻辑的返回值。</p><p>TServer主要任务就是高效的接受Client的请求，并将请求转发到Processor进行处理，主要有以下实现：</p><ul><li>TSimpleServer：简单的单线程网络阻塞模型，同时只能服务一个client连接，其他所有客户端在被服务器端接受之前都只能等待，主要用于测试。</li><li>TNonblockingServer：多线程服务模型，使用了NIO中的<code>Selector</code>选择器，通过调用<code>select()</code>，使得客户端的请求阻塞在多个连接上，而不是在单一的连接；可以服务多个客户端。</li><li>THsHaServer：使用单独的线程来处理网络I/O，一个独立的worker线程池来处理消息，只要有空闲的worker线程就会被立即处理。</li><li>TThreadedSelectorServer：维护了两个线程池，一个用来处理网络I/O，另一个用来进行请求的处理。当网络I/O是瓶颈的时候，TThreadedSelectorServer比THsHaServer的表现要好。</li><li>TThreadPoolServer：线程池网络模型，是将每一个请求都加入到<code>ThreadPoolExecutor</code>线程池中，并绑定其中一个worker线程去处理，直到关闭。</li></ul><p>TProtocol 是传输协议层，主要负责结构化数据，并组装成Message，或者从Message结构中读出结构化数据。将一个有类型的数据转化为字节流以交给TTransport进行传输，或者从TTransport中读取一定长度的字节数据转化为特定类型的数据。如int32会被TBinaryProtocol Encode为一个四字节的字节数据，或者TBinaryProtocol从TTransport中取出四个字节的数据Decode为int32。</p><blockquote><p>传输协议包括：TBinaryProtocol（基于二进制编码传输的协议），TCompactProtocol（紧凑，高效的二进制传输协议，使用Variable-Length Quantity (VLQ) 编码对数据编码压缩，主要是对整数采用可变长度），TJSONProtocol（使用JSON格式编码的传输协议），TDebugProtocol（文本格式，方便抓包Debug）。</p></blockquote><p>TTransport 传输层负责以字节流方式发送和接收Message，是底层IO模块在Thrift框架中的实现，每一个底层IO模块都会有一个对应TTransport来负责Byte Stream（字节流）数据在该IO模块上的传输，有以下TTransport的实现：</p><ul><li>TSocket：阻塞型 socket，是最常见的模式，用于客户端，采用系统函数 read 和 write 进行读写数据</li><li>TServerSocket：非阻塞型 socket，用于服务器端，accecpt 到的 socket 类型都是 TSocket</li><li>THttpTransport：采用HTTP传输协议进行传输，非阻塞式中使用</li><li>TFramedTransport：按块的大小进行传输，支持定长数据发送和接收</li><li>TFileTransport：用于写数据到文件，以文件形式进行传输</li><li>TMemoryBuffer：从一个缓冲区中读写数据，Java实现使用的是<code>ByteArrayOutputStream</code></li><li>TZlibTransport：Java中采用<code>java.util.zip</code>包，来进行压缩和解压缩</li></ul><p>底层IO模块，负责实际的数据传输，包括Socket，文件，或者压缩数据流等。</p><h3 id="Show-me-your-code"><a href="#Show-me-your-code" class="headerlink" title="Show me your code"></a>Show me your code</h3><p>项目需要引入<code>libthrift</code>依赖：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.thrift&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;libthrift&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">0.12</span><span class="number">.0</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p>创建接口实现类实现<code>HelloMethod.Iface</code>接口，并实现相应方法的处理逻辑和返回。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloThriftImpl</span> <span class="keyword">implements</span> <span class="title">HelloMethod</span>.<span class="title">Iface</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 除法，整除</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">division</span><span class="params">(<span class="keyword">int</span> param1, <span class="keyword">int</span> param2)</span> <span class="keyword">throws</span> RequestException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> value = param1 / param2;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// say + username</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello &quot;</span>+username;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建 <code>ThriftServer.java</code> 实现服务端，关键代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThriftServer</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initServer</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 设置多线程服务模型</span></span><br><span class="line">            TNonblockingServerSocket socket = <span class="keyword">new</span> TNonblockingServerSocket(<span class="number">9090</span>);</span><br><span class="line">            <span class="comment">// 关联业务处理器TProcessor</span></span><br><span class="line">            TProcessor processor = <span class="keyword">new</span> HelloMethod.Processor(<span class="keyword">new</span> HelloThriftImpl());</span><br><span class="line">            <span class="comment">// 设置二进制传输协议，TFramedTransport传输方式和关联业务处理</span></span><br><span class="line">            TNonblockingServer.Args arg = <span class="keyword">new</span> TNonblockingServer.Args(socket);</span><br><span class="line">            arg.protocolFactory(<span class="keyword">new</span> TBinaryProtocol.Factory());</span><br><span class="line">            arg.transportFactory(<span class="keyword">new</span> TFramedTransport.Factory());</span><br><span class="line">            arg.processorFactory(<span class="keyword">new</span> TProcessorFactory(processor));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 开启服务</span></span><br><span class="line">            TServer server = <span class="keyword">new</span> TNonblockingServer (arg);</span><br><span class="line">            System.out.println(<span class="string">&quot;start server port 9090 ...&quot;</span>);</span><br><span class="line">            server.serve();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (TTransportException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        initServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建<code>ThriftClient.java</code>实现客户端：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThriftClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sendServerRequest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 创建客户端连接，url，port，timeout</span></span><br><span class="line">            TSocket socket = <span class="keyword">new</span> TSocket(<span class="string">&quot;localhost&quot;</span>, <span class="number">9090</span>, <span class="number">3000</span>);</span><br><span class="line">            <span class="comment">// 设置TFramedTransport传输方式，二进制传输协议</span></span><br><span class="line">            TTransport transport = <span class="keyword">new</span> TFramedTransport(socket);</span><br><span class="line">            TProtocol protocol = <span class="keyword">new</span> TBinaryProtocol(transport);</span><br><span class="line">            <span class="comment">// open client</span></span><br><span class="line">            socket.open();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 实例客户端业务处理，调用方法,返回结果</span></span><br><span class="line">            HelloMethod.Client client = <span class="keyword">new</span> HelloMethod.Client(protocol);</span><br><span class="line">            <span class="comment">// hello + pross</span></span><br><span class="line">            String hello = client.sayHello(<span class="string">&quot;pross&quot;</span>);</span><br><span class="line">          	<span class="comment">// 3/1 =3</span></span><br><span class="line">            <span class="keyword">int</span> value = client.division(<span class="number">3</span>, <span class="number">1</span>);</span><br><span class="line">            System.out.println(hello);</span><br><span class="line">            System.out.println(<span class="string">&quot;division value:&quot;</span>+value);</span><br><span class="line">          </span><br><span class="line">          	socket.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (TTransportException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RequestException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (TException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        sendServerRequest();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先运行服务端，出现提示：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start server port 9090 ...</span><br></pre></td></tr></table></figure><p>然后运行客户端，控制台打印出：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hello pross</span><br><span class="line">division value:3</span><br></pre></td></tr></table></figure><p>看到了预料之中的结果，Thrift演出毕。</p><h3 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h3><p><a target="_blank" rel="noopener" href="http://zheming.wang/blog/2014/08/28/94D1F945-40EC-45E4-ABAF-3B32DFFE4043/">Thrift RPC详解</a></p><p><a href="%5Bhttp://diwakergupta.github.io/thrift-missing-guide/thrift.pdf%5D(http://diwakergupta.github.io/thrift-missing-guide/thrift.pdf)">Thrift: The Missing Guide</a></p><p><a target="_blank" rel="noopener" href="https://thrift.apache.org/">Apache Thrift</a></p><p>完。</p></div><footer><div class="tags"><a class="tags-none-link" href="/tags/%E6%8A%80%E6%9C%AF/" rel="tag">技术</a></div><div class="clearfix"></div></footer></article></div></div><footer id="footer"><div class="copyright">&copy; 2025 <a href="/">pross</a> <span>,</span> Theme by <a href="https://github.com/orderedlist" target="_blank">orderedlist</a></div><div class="clearfix"></div></footer><script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script><script src="/js/scale.fix.js"></script><script src="/js/jquery.imagesloaded.min.js"></script><script src="/js/gallery.js"></script><link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css"><script src="/fancybox/jquery.fancybox.pack.js"></script><script type="text/javascript">jQuery(".fancybox").fancybox()</script><script src="/assets/mmedia/mmedia-loader.js"></script></body></html>