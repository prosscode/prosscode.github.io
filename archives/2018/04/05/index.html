<!-- build time:Mon Sep 24 2018 20:35:28 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>MapReduce编程案例（下） · PROSS</title><meta name="description" content="MapReduce编程案例（下） - RukiapR0ss"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://pross.space/atom.xml" title="PROSS"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/prosscode" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">MapReduce编程案例（下）</h1><div class="post-info">Apr 5, 2018</div><div class="post-content"><ul><li>Versions变动版本记录</li><li>数值累加</li></ul><a id="more"></a><h4 id="Version变动版本记录"><a href="#Version变动版本记录" class="headerlink" title="Version变动版本记录"></a>Version变动版本记录</h4><p>在所有有版本变动的记录后面追加一条字段信息：该信息就是上一个版本的版本号，只限同用户</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">数据格式：</div><div class="line"><span class="number">20170308</span>,黄渤,光环斗地主,<span class="number">8</span>,<span class="number">360</span>手机助手,<span class="number">0.1</span>版本,北京</div><div class="line"><span class="number">20170308</span>,黄渤,光环斗地主,<span class="number">22</span>,<span class="number">360</span>手机助手,<span class="number">0.2</span>版本,北京</div><div class="line"><span class="number">20170308</span>,黄渤,光环斗地主,<span class="number">14</span>,<span class="number">360</span>手机助手,<span class="number">0.3</span>版本,北京</div><div class="line">...</div><div class="line">字段信息：</div><div class="line">用户ID，用户名，游戏名，小时，数据来源，游戏版本，用户所在地</div><div class="line">id, name, game, hour, source, version, city</div></pre></td></tr></table></figure><p>思路：把id、name、game、hours、source、version、city封装成<code>Version</code>对象，实现<code>WritableComparable</code>接口，并根据id、name、version先后排序。排序后判断相邻的数据版本号是否一致来进行版本号的添加。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.pross.version;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.DataInput;</div><div class="line"><span class="keyword">import</span> java.io.DataOutput;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.WritableComparable;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> pross shawn</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * create time：2018年3月19日</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * content：Version实体类</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Version</span> <span class="keyword">implements</span> <span class="title">WritableComparable</span>&lt;<span class="title">Version</span>&gt;</span>&#123;</div><div class="line">	<span class="keyword">private</span> String id;</div><div class="line">	<span class="keyword">private</span> String name;</div><div class="line">	<span class="keyword">private</span> String game;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> hour;</div><div class="line">	<span class="keyword">private</span> String source;</div><div class="line">	<span class="keyword">private</span> String version;</div><div class="line">	<span class="keyword">private</span> String city;</div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> id;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(String id)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.id = id;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> name;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.name = name;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getGame</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> game;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setGame</span><span class="params">(String game)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.game = game;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getHour</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> hour;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHour</span><span class="params">(<span class="keyword">int</span> hour)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.hour = hour;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getSource</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> source;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSource</span><span class="params">(String source)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.source = source;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getVersion</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> version;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVersion</span><span class="params">(String version)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.version = version;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getCity</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> city;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCity</span><span class="params">(String city)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.city = city;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Version</span><span class="params">(String id, String name, String game, <span class="keyword">int</span> hour, String source, String version, String city)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>();</div><div class="line">		<span class="keyword">this</span>.id = id;</div><div class="line">		<span class="keyword">this</span>.name = name;</div><div class="line">		<span class="keyword">this</span>.game = game;</div><div class="line">		<span class="keyword">this</span>.hour = hour;</div><div class="line">		<span class="keyword">this</span>.source = source;</div><div class="line">		<span class="keyword">this</span>.version = version;</div><div class="line">		<span class="keyword">this</span>.city = city;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Version</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>();</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> id + <span class="string">","</span> + name + <span class="string">","</span> + game + <span class="string">","</span> + hour + <span class="string">","</span> + source+ <span class="string">","</span> + version + <span class="string">","</span> + city;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="comment">/*</span></div><div class="line"><span class="comment">	 * 序列化与反序列化</span></div><div class="line"><span class="comment">	 */</span></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(DataOutput out)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		out.writeUTF(id);</div><div class="line">		out.writeUTF(name);</div><div class="line">		out.writeUTF(game);</div><div class="line">        out.writeInt(hour);  </div><div class="line">        out.writeUTF(source);  </div><div class="line">        out.writeUTF(version);  </div><div class="line">        out.writeUTF(city);  </div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readFields</span><span class="params">(DataInput in)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		<span class="keyword">this</span>.id = in.readUTF();</div><div class="line">		<span class="keyword">this</span>.name = in.readUTF();</div><div class="line">		<span class="keyword">this</span>.game = in.readUTF();</div><div class="line">		<span class="keyword">this</span>.hour = in.readInt();</div><div class="line">		<span class="keyword">this</span>.source = in.readUTF();</div><div class="line">		<span class="keyword">this</span>.version = in.readUTF();</div><div class="line">		<span class="keyword">this</span>.city = in.readUTF();</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="comment">/*</span></div><div class="line"><span class="comment">	 * 比较器 排序</span></div><div class="line"><span class="comment">	 */</span></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Version version)</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> resultID=<span class="keyword">this</span>.id.compareTo(version.getId());</div><div class="line">		<span class="keyword">if</span>(resultID==<span class="number">0</span>)&#123;</div><div class="line">			<span class="keyword">int</span> resultName=<span class="keyword">this</span>.name.compareTo(version.getName());</div><div class="line">			<span class="keyword">if</span>(resultName==<span class="number">0</span>)&#123;</div><div class="line">				<span class="keyword">return</span> <span class="keyword">this</span>.version.compareTo(version.getVersion());</div><div class="line">			&#125;<span class="keyword">else</span>&#123;</div><div class="line">				<span class="keyword">return</span> resultName;</div><div class="line">			&#125;</div><div class="line">		&#125;<span class="keyword">else</span>&#123;</div><div class="line">			<span class="keyword">return</span> resultID;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>在MR程序中，map阶段拆分数据后把数据封装到<code>Version</code>对象中，在reduce阶段进行数据迭代，判断版本号是否一致，当id和name不一致，证明不是两个不同的用户；如果一致，则进行版本号的拼接，放入Key中。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.pross.version;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configured;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.fs.FileSystem;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.LongWritable;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.NullWritable;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Job;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Mapper;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Reducer;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.FileInputFormat;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.util.Tool;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.util.ToolRunner;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> pross shawn</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * create time：2018年3月19日</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * content：在所有有版本变动的记录后面追加一条字段信息：该信息就是上一个版本的版本号，只限同用户</span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment"> * 	文件路径：E:\BigData\7_Hadoop\hadoop-mapreduce-day5\data\input_version</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VersionMR</span> <span class="keyword">extends</span> <span class="title">Configured</span> <span class="keyword">implements</span> <span class="title">Tool</span></span>&#123;</div><div class="line">  </div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		<span class="keyword">int</span> run=ToolRunner.run(<span class="keyword">new</span> VersionMR(), args);</div><div class="line">		System.exit(run);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">run</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		<span class="comment">//指定HDFS相关参数</span></div><div class="line">		Configuration conf=<span class="keyword">new</span> Configuration();</div><div class="line">		FileSystem fs=FileSystem.get(conf);</div><div class="line">		 </div><div class="line">		Job job=Job.getInstance(conf);</div><div class="line">		job.setJarByClass(VersionMR.class);</div><div class="line">		</div><div class="line">		<span class="comment">//指定mapper类和reduce类</span></div><div class="line">		job.setMapperClass(VersionMRMapper.class);</div><div class="line">		job.setReducerClass(VersionMRReduce.class);</div><div class="line">		</div><div class="line">		<span class="comment">//指定输出类型</span></div><div class="line">        job.setMapOutputKeyClass(Version.class);  </div><div class="line">        job.setMapOutputValueClass(NullWritable.class);  </div><div class="line">        job.setOutputKeyClass(Text.class);  </div><div class="line">        job.setOutputValueClass(NullWritable.class); </div><div class="line">        </div><div class="line">        <span class="comment">//指定路径</span></div><div class="line">        Path inputPath = <span class="keyword">new</span> Path(<span class="string">"E:\\BigData\\7_Hadoop\\hadoop-mapreduce-day5\\data\\input_version"</span>);  </div><div class="line">        Path outputPath = <span class="keyword">new</span> Path(<span class="string">"E:\\BigData\\7_Hadoop\\hadoop-mapreduce-day5\\data\\output_version"</span>); </div><div class="line">        <span class="comment">//如果输出路径存在则删除</span></div><div class="line">       <span class="keyword">if</span>(fs.exists(outputPath))&#123;</div><div class="line">    	   fs.delete(outputPath,<span class="keyword">true</span>);</div><div class="line">       &#125;</div><div class="line">       FileInputFormat.setInputPaths(job, inputPath);</div><div class="line">       FileOutputFormat.setOutputPath(job, outputPath);</div><div class="line">       </div><div class="line">       <span class="comment">//提交任务</span></div><div class="line">       <span class="keyword">boolean</span> bool = job.waitForCompletion(<span class="keyword">true</span>);</div><div class="line">       <span class="keyword">return</span> bool? <span class="number">0</span> : <span class="number">1</span> ;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	</div><div class="line">	<span class="comment">/**</span></div><div class="line"><span class="comment">	 * map组件</span></div><div class="line"><span class="comment">	 */</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">VersionMRMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">LongWritable</span>, <span class="title">Text</span>, <span class="title">Version</span>, <span class="title">NullWritable</span>&gt;</span>&#123;</div><div class="line">		<span class="comment">/*</span></div><div class="line"><span class="comment">		 * 数据格式：</span></div><div class="line"><span class="comment">		 * 20170308,黄渤,光环斗地主,8,360手机助手,0.1版本,北京</span></div><div class="line"><span class="comment">		 * 20170308,黄渤,光环斗地主,5,360手机助手,0.1版本,北京</span></div><div class="line"><span class="comment">		 * </span></div><div class="line"><span class="comment">		 * 字段信息：</span></div><div class="line"><span class="comment">		 * 用户ID，用户名，游戏名，小时，数据来源，游戏版本，用户所在地</span></div><div class="line"><span class="comment">		 * id, name, game, hour, source, version, city </span></div><div class="line"><span class="comment">		 * </span></div><div class="line"><span class="comment">		 */</span></div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(LongWritable key, Text value, Context context)</span> <span class="keyword">throws</span> IOException ,InterruptedException </span>&#123;</div><div class="line">			<span class="comment">//拆分数据</span></div><div class="line">			String[] split = value.toString().split(<span class="string">","</span>);</div><div class="line">			<span class="comment">//把数据封装到对象中</span></div><div class="line">			Version version = <span class="keyword">new</span> Version(split[<span class="number">0</span>], split[<span class="number">1</span>],split[<span class="number">2</span>],Integer.parseInt(split[<span class="number">3</span>]), split[<span class="number">4</span>], split[<span class="number">5</span>], split[<span class="number">6</span>]);</div><div class="line">			context.write(version, NullWritable.get());</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line"><span class="comment">	 * reduce组件</span></div><div class="line"><span class="comment">	 */</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">VersionMRReduce</span> <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">Version</span>, <span class="title">NullWritable</span>, <span class="title">Text</span>, <span class="title">NullWritable</span>&gt;</span>&#123;</div><div class="line">		</div><div class="line">		String lastID=<span class="keyword">null</span>;</div><div class="line">		String lastName=<span class="keyword">null</span>;</div><div class="line">		String lastVersion=<span class="keyword">null</span>;</div><div class="line">		</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(Version key, Iterable&lt;NullWritable&gt; values,Context context)</span><span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</div><div class="line">            <span class="keyword">for</span>(NullWritable nvl:values)&#123;</div><div class="line">				<span class="keyword">if</span>(lastVersion==<span class="keyword">null</span>)&#123;</div><div class="line">					<span class="comment">//第一次进入程序，lastVersion为空，直接打印，因为相当于没有上一条数据</span></div><div class="line">					context.write(<span class="keyword">new</span> Text(key.toString()), NullWritable.get());</div><div class="line">				&#125;<span class="keyword">else</span>&#123;</div><div class="line">					<span class="comment">//当ID和Name一致时</span></div><div class="line">					<span class="keyword">if</span>(lastID.equals(key.getId()) &amp;&amp; lastName.equals(key.getName()))&#123;</div><div class="line">						<span class="comment">//判断上个版本号和当前版本号是否一致</span></div><div class="line">						<span class="keyword">if</span>(!lastVersion.equals(key.getVersion()))&#123;</div><div class="line">							context.write(<span class="keyword">new</span> Text(key.toString()+<span class="string">"-"</span>+lastVersion), NullWritable.get());</div><div class="line">						&#125;</div><div class="line">						<span class="comment">//当ID和Name有一个不一致时，证明是两个不同的用户</span></div><div class="line">					&#125;<span class="keyword">else</span>&#123;</div><div class="line">						context.write(<span class="keyword">new</span> Text(key.toString()), NullWritable.get());</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">				<span class="comment">//进行数据迭代处理，方便本次和下次的数据进行对比</span></div><div class="line">				lastID=key.getId();</div><div class="line">				lastName=key.getName();</div><div class="line">				lastVersion=key.getVersion();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h4 id="数值累加"><a href="#数值累加" class="headerlink" title="数值累加"></a>数值累加</h4><p>求所有数对应位置的叠加和</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">举例：</div><div class="line"><span class="number">0001</span>.txt文件有数据：</div><div class="line"><span class="number">1</span></div><div class="line"><span class="number">2</span></div><div class="line"><span class="number">3</span></div><div class="line"><span class="number">4</span></div><div class="line">...</div><div class="line"><span class="number">10</span></div><div class="line"><span class="number">0002</span>.txt文件有数据：</div><div class="line"><span class="number">10</span></div><div class="line"><span class="number">10</span></div><div class="line"><span class="number">10</span></div><div class="line"><span class="number">10</span></div><div class="line">...</div><div class="line">返回结果是：</div><div class="line"><span class="number">1</span>	<span class="number">1</span></div><div class="line"><span class="number">2</span>	<span class="number">3</span></div><div class="line"><span class="number">3</span>	<span class="number">6</span></div><div class="line"><span class="number">4</span>	<span class="number">10</span></div><div class="line">...</div><div class="line"><span class="number">10</span>	<span class="number">55</span></div><div class="line">也就是，每一行数字后面都追加一个累加到该数字的和值</div></pre></td></tr></table></figure><p>思路：先求出每个文件的总和，然后按照文件的顺序进行叠加</p></div></article></div></main><footer><div class="paginator"><a href="/archives/2018/04/16/" class="prev">PREV</a><a href="/archives/2018/03/28/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname="pross",disqus_identifier="archives/2018/04/05/",disqus_title="MapReduce编程案例（下）",disqus_url="https://pross.space/archives/2018/04/05/";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><script id="dsq-count-scr" src="//pross.disqus.com/count.js" async></script><div class="copyright"><p>© 2017 - 2018 <a href="https://pross.space">RukiapR0ss</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html><!-- rebuild by neat -->