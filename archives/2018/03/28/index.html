<!-- build time:Tue May 29 2018 14:41:21 GMT+0800 (中国标准时间) --><!doctype html><html lang="zh-Hans"><head><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="author" content="RukiapR0ss"><meta name="description" content=""><title>MapReduce编程框架之Shuffle详述 [ PROSS ]</title><link rel="alternate" href="/atom.xml" title="PROSS"><link rel="shortcut icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/random.css"><link rel="stylesheet" href="/css/vegas.min.css"><link rel="stylesheet" href="/css/highlight-railscasts.css"><link rel="stylesheet" href="/css/jquery.fancybox.css"><link rel="stylesheet" href="/css/iconfont/iconfont.css"><link rel="stylesheet" href="/css/jquery.fancybox-thumbs.css"><link rel="stylesheet" href="/css/plyr.css"></head><body><div class="side-navigate hide-area"><div class="item prev"><a href="/archives/2018/04/05/"><div class="item-icon"></div></a><div class="item-title">MapReduce编程案例（下）</div></div><div class="item next"><a href="/archives/2018/03/18/"><div class="item-icon"></div></a><div class="item-title">MapReduce编程案例（上）</div></div></div><div id="outer-container" class="hide-area"><div id="container"><div id="menu-outer" class="slide-down"><div id="menu-inner"><div id="brand"><a onclick="openUserCard()"><img id="avatar" src="/images/avatar.jpg"><div id="homelink">PROSS</div></a></div><div id="menu-list"><ul><li><a href="/index.html">Home</a></li><li class="active"><a href="/archives">Archives</a></li><li><a href="/tags">Tags</a></li><li><a href="/about">About</a></li></ul></div><div id="show-menu"><button>Menu</button></div></div></div><div id="content-outer"><div id="content-inner"><article id="post"><h1>MapReduce编程框架之Shuffle详述</h1><p class="page-title-sub"><span id="post-title-date">Created at 2018-03-28</span> <span id="post-title-updated">Updated at 2018-05-18</span> <span id="post-title-tags">Tag <a href="/tags/BigData/">BigData</a></span></p><p><img src="/archives/2018/03/28/shuffle.png" alt=""></p><a id="more"></a><h3 id="Shuffle是什麽"><a href="#Shuffle是什麽" class="headerlink" title="Shuffle是什麽"></a>Shuffle是什麽</h3><p>Shuffle：数据混洗，核心机制有数据分区、排序、局部聚合、缓存、拉取、再合并排序。</p><p>Shuffle是MapReduce处理流程中的一个核心过程，由封面图可以看出，它的每一个处理步骤是分散在各个mapTask和ReduceTask节点上完成的，整体分为3个操作：Partitioner（分区，NumReduceTask只有一个或者没有分区操作将不会起作用）、Sort（排序，根据key排序，没有reducer阶段，那么就不会对key排序）、Combiner（合并，局部value的合并，可选组件）</p><h3 id="MapReuce中的Shuffle"><a href="#MapReuce中的Shuffle" class="headerlink" title="MapReuce中的Shuffle"></a>MapReuce中的Shuffle</h3><p>我们先捋一捋MapReduce的执行流程：</p><p><img src="/archives/2018/03/28/mapreduce.png" alt=""></p><p>我们知道，一个大文件需要处理，在HDFS上是以block块的形式存放，Hadop2.x之后的每个block默认为128M，默认副本为3份，运行每个map任务会处理一个split，一般split大小和block相同，那么有多少block就有多少个map任务。</p><p>每个map任务处理完输入的split后会把结果写入到内存的一个环形缓冲区，写入过程中会进行简单的排序，默认大小为100M，当缓冲区的大小使用超过一定的阀值，一个后台的线程就会启动把缓冲区中的数据溢写（spill）到本地磁盘中，同时Mapper继续向环形缓冲区中写入数据。</p><p>数据溢写入到磁盘之前，首先会根据Reducer的数量划分成同数量的分区（partition），每个分区中的数据都会有后台线程根据map任务的输出结果进行内排序（字典数序，自然数顺序或自定义顺序comparator），如果有combiner（作用是使map输出更紧凑，写到本地磁盘和传给reducer的数据更少），Mapper会在溢写到磁盘之前排好序的输出上运行，最后在本地生成分好区排好序的小文件；如果map向环形缓冲区写入数据的速度大于向本地写入数据，环形缓冲区就会被写满，向环形缓冲区写入的数据的线程就会阻塞直至缓冲区中的内容全部溢写到磁盘后再次启动，到阀值后回想本地磁盘新建一个溢写文件。</p><p>map任务完成之前，会把本地磁盘溢写的所有文件不停地合并成得到一个结果文件，合并得到的结果文件会根据溢写文件的分区而分区，每个分区的数据会再次根据key进行排序，得到的结果文件是分好区并且排好序的；可以合并成一个文件的溢写文件数量默认为10，这个结果文件的分区存在一个映射关系。</p><p>Reduce任务启动，Reducer个数由mapred-site.xml的mapreduce.job.reducers配置决定，或者初始化job时调用Job.setNumReduceTask来设置；Reducer中的一个线程定期向MRAppMastrer询问Mapper输出结果文件位置，mapper结束后会向MRAppMaster汇报信息；从而Reducer得知Mapper状态，得到map结果文件目录。</p><p>当有一个Mapper结束时，reduce任务进入复制阶段，通过http协议（hadoop内置了netty容器）把所有Mapper结果文件的对应的分区数据复制过来，比如：编号为0的reduce复制maop结果文件中0号分区数据，1号reduce复制map结果文件中1号分区的数据等；Reducer可以并行复制Mappere的结果，默认线程数为5（mapred-site.xml：mapreduce.reduce.shuffle.parallelcoopies）；</p><p>所有Reducer复制完成map结果文件后，由于Reducer会失败，NodeManager并没有在第一个map结果文件复制完成后删除他，直到作业完成后MRAppMaster通知NodeManager进行删除</p><p>另外：如果map结果文件相当小，则会被直接复制到reduce NodeManager的内存中（缓冲区大小由mapred.site.xml：mapreduce.shuffle.input.buffer.percent指定，默认为0.7），一旦缓冲区达到reduce的阀值大小0.66或写入到reduce NodeManager内存中文件个数达到map输出阀值1000（mapred-site.xml：mapreduce.reduce.merge.inmen.threshold），reduce就会把map结果文件合并溢写到本地。</p><p>复制阶段完成后，Ruducer进入到Merge阶段，循环的合并map结果文件，维持其顺序排列，合并因子默认为10（mapred-site.xml：mapreduce.task.io.start.factor），经过不断的Merge后得到一个”最终文件”，可能存储在磁盘也可能存在内存中。</p><p>“最终文件”输入到reduce进行计算，计算结果输入到HDFS文件系统中存储。</p><p><strong>shuffle流程</strong></p><p><img src="/archives/2018/03/28/shuffle-rim.png" alt=""></p><p>回到map阶段，mapTask 是收集 map()方法输出的 K-V 对，放到内存缓冲区 kvbuffer（环形缓冲区：内存中的一种首尾相连的数据结构，kvbuffer 包含数据区和索引区）中</p><p>从内存缓冲区中的数据区的数据不断溢出本地磁盘文件 file.out，可能会溢出多次，则会有多个文件，相应的内存缓冲区中的索引区数据溢出为磁盘索引文件 file.out.index</p><p>多个溢出文件会被合并成大的溢出文件</p><p>在溢出过程中，及合并的过程中，都要调用 partitoner 进行分区和针对 key 进行排序</p><p>在数据量大的时候，可以对 mapTask 结果启用压缩，将 mapreduce.map.output.compress设为 true，并使用 mapreduce.map.output.compress.codec 设置使用的压缩算法，可以提高数据传输到 reducer 端的效率</p><p>reduceTask 根据自己的分区号，去各个 mapTask 机器上取相应的结果分区数据，取到同一个分区的来自不同 mapTask 的结果文件，reduceTask 会将这些文件再进行合并（归并排序）</p><p>合并成大文件后，shuffle 的过程也就结束了，后面进入 reduceTask 的逻辑运算过程（从文件中取出一个一个的键值对 group，调用用户自定义的 reduce()方法）</p><p>Shuffle 中的缓冲区大小会影响到 mapreduce 程序的执行效率，原则上说，缓冲区越大，磁盘 io 的次数越少，执行速度就越快</p><blockquote><p>缓冲区的大小可以通过参数调整，参数：mapreduce.task.io.sort.mb 默认 100M</p><p>缓冲区的溢写比也可以通过参数调整，参数：mapreduce.map.sort.spill.percent 默认 0.8</p></blockquote><p><strong>带上shuffle后mapreduce执行流程图</strong></p><p><img src="/archives/2018/03/28/mapreduce-shuffle.png" alt=""></p></article><div class="random-toc-area"><button class="btn-hide-toc btn-hide-toc-show" style="display:none" onclick="TOCToggle()">Show TOC</button> <button class="btn-hide-toc btn-hide-toc-hide" onclick="TOCToggle()">Hide TOC</button><div class="random-toc"><h2>Table of Content</h2><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Shuffle是什麽"><span class="toc-text">Shuffle是什麽</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MapReuce中的Shuffle"><span class="toc-text">MapReuce中的Shuffle</span></a></li></ol></div></div><nav id="pagination"><a href="/archives/2018/04/05/" class="prev">&larr; Prev post MapReduce编程案例（下）</a> <a href="/archives/2018/03/18/" class="next">Next post MapReduce编程案例（上） &rarr;</a></nav><div id="uyan_frame"></div></div></div><div id="bottom-outer"><div id="bottom-inner">Site by RukiapR0ss using <a href="http://hexo.io">Hexo</a> & <a href="https://github.com/stiekel/hexo-theme-random">Random</a><br></div></div></div></div><script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2160266"></script><div id="user-card"><div class="center-field"><img class="avatar" src="/images/avatar.jpg"><p id="description">我不会去表白，爱就是这么让人难堪，你也知道这藏头诗是多么无趣</p><ul class="social-icon"><li><a href="https://github.com/prosscode"><i class="icon iconfont github">&#xe606;</i></a></li><li><a href="https://www.zhihu.com/people/ProSS"><i class="icon iconfont zhihu">&#xe60b;</i></a></li><li><a href="/atom.xml"><i class="icon iconfont rss">&#xe60e;</i></a></li></ul></div></div><div id="btn-view">Hide</div><script>var isIgnoreHost=!1;window&&window.location&&window.location.host&&(isIgnoreHost=["localhost","127.0.0.1"].some(function(o){return 0===window.location.host.indexOf(o)}));var isTriggerAnalytics=!isIgnoreHost</script><script src="/js/jquery-2.2.3.min.js"></script><script src="/js/vegas.min.js"></script><script src="/js/random.js"></script><script src="/js/highlight.pack.js"></script><script src="/js/jquery.mousewheel.pack.js"></script><script src="/js/jquery.fancybox.pack.js"></script><script src="/js/jquery.fancybox-thumbs.js"></script><script src="/js/plyr.js"></script><script>var backgroundImages=[];$("#post").each(function(t){$(this).find("img").each(function(){if(!$(this).parent().hasClass("fancybox")&&!$(this).parent().hasClass("fancybox-thumb")){var t=this.alt||this.title;t&&$(this).after('<span class="caption">'+t+"</span>"),$(this).wrap('<a href="'+this.src+'" title="'+t+'" class="fancybox"></a>')}}),$(this).find(".fancybox").each(function(){$(this).attr("rel","post"+t)})}),$(".fancybox").fancybox();var vegasConfig={"preload­Image":!0,transition:["fade2"],timer:!0,delay:15e3,shuffle:!0,count:20},unsplashConfig={gravity:"center"},turnoffBackgroundImage=!1;turnoffBackgroundImage=!0;var backgroundColor="34495E";$(".fancybox-thumb").fancybox({prevEffect:"none",nextEffect:"none",helpers:{title:{type:"outside"},thumbs:{width:50,height:50}}}),$(".video-container iframe").each(function(t){var a=$(this).attr("src"),e=a.split("/").pop(),s=document.createElement("div");s.className="plyr";var n=document.createElement("div");switch(n.dataset.videoId=e,!0){case a.search("youtube.com")>=0:n.dataset.type="youtube";break;case a.search("vimeo.com")>=0:n.dataset.type="vimeo";break;default:return}s.appendChild(n),$(this).parent().html(s)}),plyr.setup(".plyr",{iconUrl:"/css/sprite.svg"})</script></body></html><!-- rebuild by neat -->